const fs = require("fs");
const path = require("path");

function logWalletAction({ action, userId, provider, walletId, source }) {
  const auditPath = path.resolve(__dirname, "audit-report.json");
  const timestamp = new Date().toISOString();

  const entry = {
    action,
    userId,
    provider,
    walletId,
    timestamp,
    source
  };

  let auditLog = [];

  if (fs.existsSync(auditPath)) {
    const raw = fs.readFileSync(auditPath, "utf8");
    try {
      const parsed = JSON.parse(raw);
      auditLog = Array.isArray(parsed) ? parsed : [parsed]; // ✅ Normalize to array
    } catch (err) {
      console.error("⚠️ Failed to parse existing audit log. Starting fresh.");
    }
  }

  auditLog.push(entry);
  fs.writeFileSync(auditPath, JSON.stringify(auditLog, null, 2));
  console.log("✅ Audit entry logged.");
}